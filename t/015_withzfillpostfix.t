use strict;
use warnings;

use Math::Clipper ':all';
use Test::More tests => 1;

# This test is specific to the ZFT_BOTH_UINT32 Z setting callback in zfill.h
# which works well for some simple cases, but needs more development to see
# if it can be made to work in all cases.

# This test could be reduced to a simpler polygon that covers more cases
# - this was just the first polygon at hand during development.

my $subjects = [ &subjects, &clips ];
#my $clips = [ &clips ];
my $results = [ &results ];

#diag("1 in:\n".pfmt($p1)."\nin:\n".pfmt($p2)."\n\n");

my $clipper = Math::Clipper->new();

$clipper->add_subject_polygons($subjects);
#$clipper->add_subject_polygons($clips);
my $result = $clipper->execute(CT_UNION,PFT_NONZERO,PFT_NONZERO,ZFT_BOTH_UINT32);
#diag("out:\n".join("\nout:\n",map pfmt($_), @$result)."\n");
is_deeply($result, $results, 'problem case works');

sub pfmt {
    my $polygon = shift;
    return join("\n",map {'['.join(', ',@$_).']'} @$polygon);
}

sub subjects { return (
[
  [18494000,250000,8],
  [18494000,36750000,8],
  [16506001,36750000,8],
  [16506001,13750000,8],
  [7425828,13750000,8],
  [7395258,13361519,8],
  [8421675,13198971,8],
  [8985249,13109721,8],
  [10267559,12455894,8],
  [10775803,12196749,8],
  [11793400,11179151,8],
  [12196749,10775802,8],
  [12850542,9493561,8],
  [13109721,8985250,8],
  [13289087,7852632,8],
  [13289086,7852632,8],
  [13424114,7000000,8],
  [13289086,6147365,8],
  [13289087,6147365,8],
  [13109721,5014748,8],
  [12920110,4642876,8],
  [12196749,3224195,8],
  [11793400,2820846,8],
  [10775803,1803248,8],
  [10267559,1544103,8],
  [8985250,890275,8],
  [8421675,801025,8],
  [7395275,638480,8],
  [7425845,250000,8],
]);
}

sub clips { return (
[
  [7052358,126246,5],
  [7110270,132676,5],
  [8492845,351625,5],
  [9085999,451180,5],
  [9227240,502929,5],
  [10624850,1215547,5],
  [10531673,1673158,2],
  [9022830,903824,2],
  [8946885,879137,2],
  [8422458,796086,2],
  [7039884,577137,2],
  [7009076,574160,2],
  [6960113,577137,2],
  [6115197,710941,2],
  [5053113,879137,2],
  [4977166,903825,2],
  [4366939,1214969,2],
  [3257165,1780824,2],
  [3192685,1827685,2],
  [2840650,2179721,2],
  [2817309,2203061,2],
  [1827685,3192686,2],
  [1780824,3257166,2],
  [1639472,3534390,2],
  [903825,4977166,2],
  [879137,5053113,2],
  [859889,5174655,2],
  [577137,6960114,2],
  [573999,6999999,2],
  [577137,7039885,2],
  [859889,8825342,2],
  [879137,8946885,2],
  [903825,9022832,2],
  [1639472,10465607,2],
  [1780824,10742831,2],
  [1827685,10807311,2],
  [2840651,11820277,2],
  [3192685,12172312,2],
  [3257166,12219173,2],
  [4366939,12785027,2],
  [4977167,13096171,2],
  [5053113,13120859,2],
  [6115198,13289055,2],
  [6960113,13422860,2],
  [7009076,13425837,2],
  [7039884,13422860,2],
  [8946884,13120859,2],
  [9022831,13096171,2],
  [10531669,12326841,3],
  [10624765,12784052,3],
  [9161946,13524128,5],
  [9017271,13565320,5],
  [7083166,13870774,5],
  [6981766,13875008,5],
  [6889726,13867321,5],
  [6044811,13733516,5],
  [4913996,13548815,5],
  [4772758,13497066,5],
  [4162530,13185922,5],
  [2992615,12583196,5],
  [2874486,12490510,5],
  [2522452,12138475,5],
  [2522453,12138474,5],
  [1463664,11071864,5],
  [1379929,10947241,5],
  [1238577,10670017,5],
  [475868,9161947,5],
  [434676,9017272,5],
  [415428,8895729,5],
  [128523,7075179,5],
  [125385,6964704,5],
  [132676,6889727,5],
  [415428,5104268,5],
  [451180,4913998,5],
  [502930,4772756,5],
  [1238577,3329980,5],
  [1416803,2992613,5],
  [1509487,2874488,5],
  [2499118,1884856,5],
  [2522451,1861523,5],
  [2928132,1463664,5],
  [3052755,1379929,5],
  [4162530,814074,5],
  [4838051,475868,5],
  [4982726,434676,5],
  [6044810,266480,5],
  [6932803,127966,5],
]

);
}

sub results { return (
[
  [7110270,132676,5],
  [7851124,250000,21474836488],#5,8
  [18494000,250000,8],
  [18494000,36750000,8],
  [16506001,36750000,8],
  [16506001,13750000,8],
  [7847895,13750000,34359738373],#8,5 TROUBLE IS/WAS HERE - SHOULD BE 8,5 LIKE HERE, BUT COMES/CAME OUT 5,8
  [7083166,13870774,5],
  [6981766,13875008,5],
  [6889726,13867321,5],
  [6044811,13733516,5],
  [4913996,13548815,5],
  [4772758,13497066,5],
  [4162530,13185922,5],
  [2992615,12583196,5],
  [2874486,12490510,5],
  [2522452,12138475,5],
  [2522453,12138474,5],
  [1463664,11071864,5],
  [1379929,10947241,5],
  [1238577,10670017,5],
  [475868,9161947,5],
  [434676,9017272,5],
  [415428,8895729,5],
  [128523,7075179,5],
  [125385,6964704,5],
  [132676,6889727,5],
  [415428,5104268,5],
  [451180,4913998,5],
  [502930,4772756,5],
  [1238577,3329980,5],
  [1416803,2992613,5],
  [1509487,2874488,5],
  [2499118,1884856,5],
  [2522451,1861523,5],
  [2928132,1463664,5],
  [3052755,1379929,5],
  [4162530,814074,5],
  [4838051,475868,5],
  [4982726,434676,5],
  [6044810,266480,5],
  [6932803,127966,5],
  [7052358,126246,5],
]
,
[
  [6960113,577137,2],
  [6115197,710941,2],
  [5053113,879137,2],
  [4977166,903825,2],
  [4366939,1214969,2],
  [3257165,1780824,2],
  [3192685,1827685,2],
  [2840650,2179721,2],
  [2817309,2203061,2],
  [1827685,3192686,2],
  [1780824,3257166,2],
  [1639472,3534390,2],
  [903825,4977166,2],
  [879137,5053113,2],
  [859889,5174655,2],
  [577137,6960114,2],
  [573999,6999999,2],
  [577137,7039885,2],
  [859889,8825342,2],
  [879137,8946885,2],
  [903825,9022832,2],
  [1639472,10465607,2],
  [1780824,10742831,2],
  [1827685,10807311,2],
  [2840651,11820277,2],
  [3192685,12172312,2],
  [3257166,12219173,2],
  [4366939,12785027,2],
  [4977167,13096171,2],
  [5053113,13120859,2],
  [6115198,13289055,2],
  [6960113,13422860,2],
  [7009076,13425837,2],
  [7039884,13422860,2],
  [7395651,13366519,8589934600],#2,8
  [7395258,13361519,8],
  [8421675,13198971,8],
  [8977251,13110988,34359738370],#8,2
  [8992463,13106043,8589934600],#2,8
  [10267559,12455894,8],
  [10775803,12196749,8],
  [11793400,11179151,8],
  [12196749,10775802,8],
  [12850542,9493561,8],
  [13109721,8985250,8],
  [13289087,7852632,8],
  [13289086,7852632,8],
  [13424114,7000000,8],
  [13289086,6147365,8],
  [13289087,6147365,8],
  [13109721,5014748,8],
  [12920110,4642876,8],
  [12196749,3224195,8],
  [11793400,2820846,8],
  [10775803,1803248,8],
  [10267559,1544103,8],
  [8992463,893953,34359738370],#8,2
  [8977253,889009,8589934600],#2,8
  [8421675,801025,8],
  [7395275,638480,8],
  [7395668,633480,34359738370],#8,2
  [7039884,577137,2],
  [7009076,574160,2],
]

);
}
__END__
